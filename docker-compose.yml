version: '3.8'

services:
    # Servi√ßo Nginx (Servidor Web)
    nginx:
        build:
            context: .docker/nginx # Constr√≥i a imagem Nginx a partir deste diret√≥rio
            dockerfile: Dockerfile
        restart: unless-stopped # üîë Reinicia automaticamente
        ports:
            - "9090:80" # ‚ö†Ô∏è CORRIGIDO: Nginx geralmente usa porta 80 internamente
        volumes:
            - .:/var/www/html # Monta o diret√≥rio atual do projeto no cont√™iner
        depends_on:
            - php # Nginx depende do PHP para iniciar
        container_name: laravel-syscad-nginx
        networks:
            - app-network

    # Servi√ßo PHP-FPM (Processador PHP)
    php:
        build:
            context: .docker/php # Constr√≥i a imagem PHP a partir deste diret√≥rio
            dockerfile: Dockerfile
        restart: unless-stopped # üîë Reinicia automaticamente
        volumes:
            - .:/var/www/html # Monta o diret√≥rio atual do projeto no cont√™iner PHP
        ports:
            - "9000:9000" # Para depura√ß√£o (opcional)
        environment:
            # Vari√°veis de ambiente para o Laravel
            DB_CONNECTION: mysql
            DB_HOST: mariadb # O nome do servi√ßo do banco de dados no docker-compose
            DB_PORT: 3306 # ‚ö†Ô∏è CORRIGIDO: MariaDB usa porta 3306 internamente
            DB_DATABASE: laravel # ‚ö†Ô∏è CORRIGIDO: Consistente com MYSQL_DATABASE
            DB_USERNAME: laravel # ‚ö†Ô∏è CORRIGIDO: Consistente com MYSQL_USER
            DB_PASSWORD: password # ‚ö†Ô∏è CORRIGIDO: Consistente com MYSQL_PASSWORD
            DB_CHARSET: utf8mb4 # ‚ö†Ô∏è MELHORADO: utf8mb4 √© mais completo
            DB_COLLATION: utf8mb4_unicode_ci # ‚ö†Ô∏è MELHORADO: Collation correspondente
            APP_ENV: production
            APP_DEBUG: false
            APP_URL: http://localhost:9090 # ‚ö†Ô∏è CORRIGIDO: URL mais gen√©rica
        depends_on:
            - mariadb # ‚úÖ ADICIONADO: PHP depende do banco
        container_name: laravel-syscad-php
        networks:
            - app-network

    # Servi√ßo MariaDB (Banco de Dados)
    mariadb:
        image: mariadb:10.11 # ‚ö†Ô∏è ATUALIZADO: Vers√£o mais recente e est√°vel
        restart: unless-stopped # üîë Reinicia automaticamente
        ports:
            - "3309:3306" # ‚ö†Ô∏è CORRIGIDO: MariaDB usa 3306 internamente
        environment:
            MYSQL_ROOT_PASSWORD: root_password # Senha root do MariaDB
            MYSQL_DATABASE: laravel # Nome do banco de dados a ser criado
            MYSQL_USER: laravel # Usu√°rio do banco de dados
            MYSQL_PASSWORD: password # Senha do usu√°rio do banco de dados
            MYSQL_CHARSET: utf8mb4 # ‚úÖ ADICIONADO: Charset padr√£o
            MYSQL_COLLATION: utf8mb4_unicode_ci # ‚úÖ ADICIONADO: Collation padr√£o
        volumes:
            # Persist√™ncia dos dados: os dados do banco ser√£o armazenados neste volume
            - dbdata:/var/lib/mysql
            # ‚úÖ ADICIONADO: Configura√ß√£o personalizada do MariaDB (opcional)
            - ./.docker/mariadb/my.cnf:/etc/mysql/conf.d/my.cnf:ro
        healthcheck: # ‚úÖ ADICIONADO: Verifica√ß√£o de sa√∫de do banco
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
            timeout: 20s
            retries: 10
            interval: 30s
            start_period: 40s
        container_name: laravel-syscad-mariadb
        networks:
            - app-network

# ‚úÖ ADICIONADO: Rede personalizada para melhor isolamento
networks:
    app-network:
        driver: bridge

# Volumes para persistir dados (banco de dados, por exemplo)
volumes:
    dbdata:
        driver: local